name: 'Infrastructure Pipeline and Code Deploy'

# üöÄ Disparadores
on:
  push:
    branches: [ "main" ]
    # Se dispara por cambios en infraestructura, backend O frontend
    paths: 
      - "terraform/**"
      - "services/app/**"
      - "services/portal/**"
      - "healthtrends-frontend/**" # ‚úÖ Agregamos la ruta del frontend
  pull_request:
    branches: [ "main" ]
    paths: [ "terraform/**" ]
  workflow_dispatch:

jobs:
  # =========================================================
  # ‚öôÔ∏è BUILD & INFRASTRUCTURE: Docker + OpenTofu
  # =========================================================
  build-and-infra:
    name: 'Build Images & Apply Infra'
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar c√≥digo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Credenciales AWS
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      # 3. Login en ECR
      - name: Log into Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: private 
          region: us-east-1

      # =========================================================
      # üê≥ PASO A: Build & Push del PORTAL (Backend)
      # =========================================================
      - name: Build and Push Portal (Backend)
        run: |
          # Variables
          ECR_REGISTRY="809829871731.dkr.ecr.us-east-1.amazonaws.com"
          IMAGE_NAME="healthtrends/portal:latest"
          FULL_IMAGE_NAME="$ECR_REGISTRY/$IMAGE_NAME"

          echo "üî® Building Portal Image..."
          docker build \
              -t $IMAGE_NAME \
              -f services/portal/Dockerfile \
              services/

          echo "üè∑Ô∏è Pushing Portal Image..."
          docker tag $IMAGE_NAME $FULL_IMAGE_NAME
          docker push $FULL_IMAGE_NAME

      # =========================================================
      # üê≥ PASO B: Build & Push del FRONTEND (React) - ¬°100% SEGURO!
      # =========================================================
      - name: Build and Push Frontend (React)
        run: |
          # Variables
          ECR_REGISTRY="809829871731.dkr.ecr.us-east-1.amazonaws.com"
          IMAGE_NAME="healthtrends-frontend:latest"
          FULL_IMAGE_NAME="$ECR_REGISTRY/$IMAGE_NAME"

          echo "üî® Building Frontend Image..."
          
          # ‚ö†Ô∏è AHORA TODO VIENE DE SECRETOS DE GITHUB:
          
          docker build \
            --build-arg VITE_COGNITO_USER_POOL_ID=${{ secrets.VITE_USER_POOL_ID }} \
            --build-arg VITE_COGNITO_APP_CLIENT_ID=${{ secrets.VITE_APP_CLIENT_ID }} \
            --build-arg VITE_READ_URL=${{ secrets.VITE_READ_URL }} \
            --build-arg VITE_INGEST_URL=${{ secrets.VITE_INGEST_URL }} \
            -t $IMAGE_NAME healthtrends-frontend/ 

          echo "üè∑Ô∏è Pushing Frontend Image..."
          docker tag $IMAGE_NAME $FULL_IMAGE_NAME
          docker push $FULL_IMAGE_NAME

      # =========================================================
      # üß± PASO C: OPENTOFU (INFRAESTRUCTURA)
      # =========================================================
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.7.0'
        
      - name: Tofu Init
        run: tofu init
        working-directory: ./terraform

      # ‚úÖ Agregado Tofu Validate como pediste
      - name: Tofu Validate
        run: tofu validate
        working-directory: ./terraform

      - name: Tofu Plan
        run: tofu plan -no-color
        working-directory: ./terraform

      # Apply (Solo se ejecuta en push a main)
      - name: Tofu Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: tofu apply -auto-approve
        working-directory: ./terraform

  # =========================================================
  # üîÑ CODE DEPLOY: Reiniciar servicios ECS
  # =========================================================
  deploy-ecs:
    name: 'Force ECS Deployment'
    needs: [build-and-infra] # Espera a que termine el build y la infra
    runs-on: ubuntu-latest
    environment: production
    
    # Solo ejecutar en main
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Force ECS Service Updates
        run: |
          echo "üîÑ Updating Portal Service (Backend)..."
          aws ecs update-service \
            --cluster healthtrends-cluster \
            --service healthtrends-portal-service \
            --force-new-deployment \
            --region us-east-1

          echo "üîÑ Updating Frontend Service..."
          aws ecs update-service \
            --cluster healthtrends-cluster \
            --service healthtrends-frontend-service \
            --force-new-deployment \
            --region us-east-1