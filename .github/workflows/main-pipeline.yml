name: 'Infrastructure Pipeline and Code Deploy'

# üöÄ Disparadores
on:
  push:
    branches: [ "main" ]
    # Se dispara por cambios en infraestructura (terraform/**) O en el c√≥digo de la API (services/app/**)
    paths: 
      - "terraform/**"
      - "services/app/**"
      - "services/portal/**"
  pull_request:
    branches: [ "main" ]
    paths: [ "terraform/**" ]
  workflow_dispatch:

jobs:
  # =========================================================
  # ‚öôÔ∏è TERRAFORM/TOFU: Despliega la infraestructura
  # =========================================================
  terraform:
    name: 'OpenTofu CI/CD'
    runs-on: ubuntu-latest
    
    # El working-directory por defecto es la ra√≠z del repositorio, lo cambiamos solo para Tofu.

    steps:
      # 1. Descargar c√≥digo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Credenciales AWS (Necesarias para Tofu y Docker)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      # =========================================================
      # üê≥ PASOS DE DOCKER: Build & Push de la imagen
      # Se ejecutan desde la ra√≠z (github.workspace)
      # =========================================================
      
      - name: Log into Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          # Usamos 'private' o 'public' seg√∫n tu registro, si es private se puede omitir.
          registry-type: private 
          region: us-east-1

      - name: Build, Tag, and Push Docker Image
        run: |
          # NOTA: Usamos el ID de cuenta duro 809829871731 de tu contexto
          ECR_REGISTRY="809829871731.dkr.ecr.us-east-1.amazonaws.com"
          IMAGE_NAME="healthtrends/portal:latest"
          FULL_IMAGE_NAME="$ECR_REGISTRY/$IMAGE_NAME"

          # 1. Construir la imagen (usando el contexto 'services/')
          # La ruta 'services/' permite a Docker acceder a 'app/' y 'portal/requirements.txt'
          docker build \
              -t $IMAGE_NAME \
              -f services/portal/Dockerfile \
              services/

          # 2. Etiquetar para ECR
          docker tag $IMAGE_NAME $FULL_IMAGE_NAME

          # 3. Subir a ECR
          docker push $FULL_IMAGE_NAME
        # working-directory: ${{ github.workspace }} es el default, no se necesita explicitar

      # =========================================================
      # üß± PASOS DE OPENTOFU (INFRAESTRUCTURA)
      # Ahora se ejecutan dentro de la carpeta 'terraform'
      # =========================================================
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.7.0'
        # Usamos working-directory para los comandos de Tofu
        
      - name: Tofu Init
        run: tofu init
        working-directory: ./terraform

      - name: Tofu Plan
        run: tofu plan -no-color
        working-directory: ./terraform

      # 6. Apply (Se ejecuta SOLO si estamos en la rama 'main')
      - name: Tofu Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: tofu apply -auto-approve
        working-directory: ./terraform

  # =========================================================
  # üîÑ CODE DEPLOY: Forzar el reinicio de ECS (para c√≥digo nuevo)
  # =========================================================
  deploy:
    name: 'Force ECS Deployment'
    needs: [terraform] # Solo se ejecuta si la infraestructura se aplica correctamente
    runs-on: ubuntu-latest
    environment: production
    
    # Solo ejecutar en main despu√©s de un apply exitoso
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Force ECS Service Deployment
        run: |
          # Reinicia el servicio ECS para usar la nueva imagen que se acaba de subir
          aws ecs update-service \
            --cluster healthtrends-cluster \
            --service healthtrends-portal-service \
            --force-new-deployment \
            --region us-east-1